<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="60">
    <title>Server Pulse | Dashboard Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --primary: #6366f1;
            --success: #22c55e;
            --danger: #ef4444;
            --text-main: #1e293b;
            --text-muted: #64748b;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 15px; }

        /* Header avec statistiques et cycle */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.5rem; margin: 0; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .stats-container { display: flex; gap: 10px; align-items: center; }
        .badge { padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.8rem; }
        .badge-cycle { background: #e0e7ff; color: #4338ca; }
        .badge-ok { background: #dcfce7; color: #15803d; }
        .badge-ko { background: #fee2e2; color: #b91c1c; }

        /* Grille haute densit√© */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); 
            gap: 12px; margin-bottom: 20px; 
        }

        .card { 
            background: var(--card-bg); border: 1px solid #e2e8f0; border-radius: 12px; 
            padding: 12px 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative; border-left: 4px solid #cbd5e1;
        }
        .card.online { border-left-color: var(--success); }
        .card.warning { border-left-color: #f59e0b; }
        .card.offline { border-left-color: var(--danger); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .card-name { font-weight: 600; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; }
        
        .actions { display: flex; gap: 8px; align-items: center; }
        .action-link { text-decoration: none; font-size: 1.1rem; filter: grayscale(1); transition: 0.2s; }
        .action-link:hover { filter: grayscale(0); transform: scale(1.1); }

        .fav-btn { cursor: pointer; background: none; border: none; font-size: 1.2rem; color: #cbd5e1; padding: 0; }
        .fav-btn.active { color: #f59e0b; }

        .status-line { display: flex; justify-content: space-between; font-size: 0.75rem; margin-top: 4px; color: var(--text-muted); }
        .status-val { font-weight: 700; }
        .text-ok { color: var(--success); }
        .text-ko { color: var(--danger); }
        .text-na { color: var(--text-muted); }

        .section-title { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; margin: 20px 0 10px; letter-spacing: 0.5px; }

        .chart-section { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 250px; }
        
        footer { text-align: center; margin-top: 30px; font-size: 0.85rem; color: var(--text-muted); padding-bottom: 20px; }
        footer a { color: var(--primary); text-decoration: none; font-weight: 600; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Server Pulse <span id="cycle-display" class="badge badge-cycle">Cycle --</span></h1>
        <div class="stats-container">
            <span id="stat-ok" class="badge badge-ok">OK: --</span>
            <span id="stat-ko" class="badge badge-ko">KO: --</span>
            <div id="last-update" style="font-size: 0.75rem; color: var(--text-muted);"></div>
        </div>
    </div>

    <div id="fav-section" style="display:none;">
        <div class="section-title">‚≠ê Favoris</div>
        <div class="grid" id="grid-fav"></div>
    </div>

    <div class="section-title">üåê Infrastructure</div>
    <div class="grid" id="grid-all"></div>

    <div class="section-title">üìà Tendance de disponibilit√©</div>
    <div class="chart-section">
        <canvas id="healthChart"></canvas>
    </div>

    <script src="data.js"></script>

    <script>
        const favs = JSON.parse(localStorage.getItem('monitorFavs') || '[]');

        function toggleFav(name) {
            const index = favs.indexOf(name);
            if(index > -1) favs.splice(index, 1);
            else favs.push(name);
            localStorage.setItem('monitorFavs', JSON.stringify(favs));
            location.reload();
        }

        if (typeof serverData !== 'undefined') {
            document.getElementById('last-update').innerText = lastUpdate;
            document.getElementById('cycle-display').innerText = "Cycle " + cycleCount;
            
            // Mise √† jour des compteurs OK/KO
            const totalOk = serverData.filter(s => s.class === 'online').length;
            const totalKo = serverData.length - totalOk;
            document.getElementById('stat-ok').innerText = "OK: " + totalOk;
            document.getElementById('stat-ko').innerText = "KO: " + totalKo;

            const gridAll = document.getElementById('grid-all');
            const gridFav = document.getElementById('grid-fav');
            const favSection = document.getElementById('fav-section');

            serverData.forEach(site => {
                const isFav = favs.includes(site.name);
                const siteUrl = site.name.startsWith('http') ? site.name : 'http://' + site.name;
                const getPillClass = (val) => val === 'OK' ? 'text-ok' : (val === 'N/A' ? 'text-na' : 'text-ko');

                const cardHtml = `
                    <div class="card ${site.class}">
                        <div class="card-header">
                            <span class="card-name" title="${site.name}">${site.name}</span>
                            <div class="actions">
                                <a href="${siteUrl}" target="_blank" class="action-link" title="Ouvrir le site">üîó</a>
                                <button class="fav-btn ${isFav ? 'active' : ''}" onclick="toggleFav('${site.name}')">‚òÖ</button>
                            </div>
                        </div>
                        <div class="status-line">
                            <span>PING</span>
                            <span class="status-val ${getPillClass(site.ping)}">${site.ping}</span>
                        </div>
                        <div class="status-line">
                            <span>WEB</span>
                            <span class="status-val ${getPillClass(site.web)}">${site.web}</span>
                        </div>
                    </div>
                `;

                if(isFav) {
                    favSection.style.display = 'block';
                    gridFav.innerHTML += cardHtml;
                } else {
                    gridAll.innerHTML += cardHtml;
                }
            });

            // Configuration optimis√©e du graphique Chart.js
            const ctx = document.getElementById('healthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historyPing.map((_, i) => "Cycle " + (i + 1)),
                    datasets: [{
                        label: 'Disponibilit√© R√©seau (Ping)',
                        data: historyPing,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }, {
                        label: 'Disponibilit√© Service (Web)',
                        data: historyWeb,
                        borderColor: '#22c55e',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: { boxWidth: 20, font: { size: 12 } }
                        }
                    },
                    scales: {
                        y: { 
                            min: 0, 
                            max: totalServers, 
                            ticks: { stepSize: 1, color: '#94a3b8' }, 
                            grid: { color: '#f1f5f9' } 
                        },
                        x: { 
                            grid: { display: false },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        }
                    }
                }
            });
        }
    </script>

    <footer>
        <p>[ Mini logiciel propos√© par <a href="https://simple-crm.ai" target="_blank">SIMPLE CRM</a> 
        et cod√© par <a href="https://www.ihaveto.be" target="_blank">Brice Cornet</a> | 
        <a href="https://crm-pour-pme.fr/open-source/monitoring.zip" target="_blank">Code open source</a> ]</p>
    </footer>
    
</body>
</html>